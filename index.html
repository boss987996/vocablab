<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>VocabLab v8.3 - Smart Sync</title>
  <meta name="description" content="Master TOEIC vocabulary with spaced repetition and AI assistance">
  <meta name="theme-color" content="#FFFFFF">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìñ</text></svg>">
   
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@0.292.0/dist/umd/lucide.js"></script>
   
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
   
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { 
            cream: '#FAFBFC',
            surface: '#FFFFFF',
            heading: '#0F172A',
            body: '#475569',
            muted: '#94A3B8',
            primary: '#F97316',
            coral: '#EF4444',
            mint: '#10B981',
            gold: '#F59E0B',
            lavender: '#8B5CF6',
            sky: '#0EA5E9',
          },
          fontFamily: {
            sans: ['Plus Jakarta Sans', 'sans-serif'],
          },
          boxShadow: {
            'soft': '0 2px 8px -2px rgba(0, 0, 0, 0.05), 0 4px 16px -4px rgba(0, 0, 0, 0.08)',
            'card': '0 1px 3px rgba(0, 0, 0, 0.04), 0 4px 12px rgba(0, 0, 0, 0.06)',
            'elevated': '0 4px 24px -4px rgba(0, 0, 0, 0.12)',
          },
          animation: {
            'fade-in': 'fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
            'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1)',
            'scale-in': 'scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
            'float': 'float 3s ease-in-out infinite',
            'shimmer': 'shimmer 2s linear infinite',
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
            scaleIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
            float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-8px)' } },
            shimmer: { '0%': { backgroundPosition: '-200% 0' }, '100%': { backgroundPosition: '200% 0' } },
          }
        }
      }
    }
  </script>
  <style>
    * { 
      font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif; 
      -webkit-tap-highlight-color: transparent; 
      box-sizing: border-box; 
    }
    html, body { 
      background: #FAFBFC;
      overscroll-behavior: none; 
      min-height: 100%; 
      height: 100%; 
      color: #0F172A;
    }
    :root { 
      --sat: env(safe-area-inset-top, 0px); 
      --sab: env(safe-area-inset-bottom, 20px); 
    }
     
    .card {
      background: #FFFFFF;
      border-radius: 20px;
      border: 1px solid #F1F5F9;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04), 0 4px 12px rgba(0, 0, 0, 0.06);
    }
     
    .input-clean {
      background: #F8FAFC;
      border: 1px solid #E2E8F0;
      transition: all 0.2s ease;
    }
    .input-clean:focus {
      background: #FFFFFF;
      border-color: #F97316;
      box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
      outline: none;
    }
     
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .pb-safe { padding-bottom: max(20px, var(--sab)); }
    .pt-safe { padding-top: max(16px, var(--sat)); }
     
    .modal-backdrop { background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(4px); }
    .modal-content { max-height: 85vh; overflow-y: auto; }
    body.modal-open { overflow: hidden; position: fixed; width: 100%; }
     
    .skeleton {
      background: linear-gradient(90deg, #F1F5F9 25%, #E2E8F0 50%, #F1F5F9 75%);
      background-size: 200% 100%;
      animation: shimmer 2s linear infinite;
    }
     
    .card-flip { perspective: 1000px; }
    .card-flip-inner {
      transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
      transform-style: preserve-3d;
    }
    .card-flip-inner.flipped { transform: rotateY(180deg); }
    .card-front, .card-back {
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }
    .card-back { transform: rotateY(180deg); }
     
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 3px; }
     
    .btn-primary {
      background: linear-gradient(135deg, #F97316 0%, #EA580C 100%);
      color: white;
      font-weight: 600;
      box-shadow: 0 2px 8px -2px rgba(249, 115, 22, 0.4);
      transition: all 0.2s ease;
    }
    .btn-primary:hover { transform: translateY(-1px); }
    .btn-primary:active { transform: scale(0.98); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
     
    .btn-secondary {
      background: #F8FAFC;
      border: 1px solid #E2E8F0;
      color: #475569;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    .btn-secondary:hover { background: #F1F5F9; }
     
    .btn-ai {
      background: linear-gradient(135deg, #8B5CF6 0%, #A78BFA 100%);
      color: white;
      font-weight: 600;
      box-shadow: 0 2px 8px -2px rgba(139, 92, 246, 0.4);
    }
     
    .gradient-text {
      background: linear-gradient(135deg, #F97316, #EAB308);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">

// ============================================
// VOCABLAB v8.3 - SMART SYNC EDITION
// Fixed: Card reset issue with Smart Merge
// ============================================

const { useState, useEffect, useMemo, useCallback, useRef } = React;

// --- FIREBASE CONFIG ---
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBRMfkAPR0492BOleYkk7O1ELal6ncNCeY",
  authDomain: "vocab-b-23bd8.firebaseapp.com",
  databaseURL: "https://vocab-b-23bd8-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "vocab-b-23bd8",
  storageBucket: "vocab-b-23bd8.firebasestorage.app",
  messagingSenderId: "100070434874",
  appId: "1:100070434874:web:0aba8abacc5667a29ded03",
  measurementId: "G-R6LX18WWT2"
};

const CONFIG = {
  INTERVALS: [1, 3, 7, 14, 30],
  MIN_EASE: 1.3,
  DEFAULT_EASE: 2.5,
  DAILY_GOAL: 20,
};

const STARTER_DECK = { id: 'starter_deck_001', title: 'TOEIC Essential', createdAt: new Date().toISOString(), color: 'primary', lastModified: Date.now() };
const STARTER_CARDS = [
  { front: 'accomplish', back: '‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', phonetic: '/…ôÀàk…ëÀêmpl…™ É/', example: 'We accomplished our goals ahead of schedule.' },
  { front: 'negotiate', back: '‡πÄ‡∏à‡∏£‡∏à‡∏≤‡∏ï‡πà‡∏≠‡∏£‡∏≠‡∏á', phonetic: '/n…™Àà…°o ä Éie…™t/', example: 'They negotiated a better contract.' },
  { front: 'deadline', back: '‡πÄ‡∏™‡πâ‡∏ô‡∏ï‡∏≤‡∏¢, ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á', phonetic: '/Ààdedla…™n/', example: 'The deadline for submission is Friday.' },
  { front: 'implement', back: '‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ, ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£', phonetic: '/Àà…™mpl…ôment/', example: 'We will implement the new system next month.' },
  { front: 'collaborate', back: '‡∏£‡πà‡∏ß‡∏°‡∏°‡∏∑‡∏≠‡∏Å‡∏±‡∏ô', phonetic: '/k…ôÀàl√¶b…ôre…™t/', example: 'Teams collaborate across departments.' },
];

// ============================================
// üî• SMART MERGE UTILITY - ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
// ============================================
const SmartMerge = {
  /**
   * Merge cards ‡πÇ‡∏î‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà lastModified ‡πÉ‡∏´‡∏°‡πà‡∏Å‡∏ß‡πà‡∏≤
   * - ‡∏ñ‡πâ‡∏≤ local ‡πÉ‡∏´‡∏°‡πà‡∏Å‡∏ß‡πà‡∏≤ ‚Üí ‡πÉ‡∏ä‡πâ local (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å overwrite)
   * - ‡∏ñ‡πâ‡∏≤ cloud ‡πÉ‡∏´‡∏°‡πà‡∏Å‡∏ß‡πà‡∏≤ ‚Üí ‡πÉ‡∏ä‡πâ cloud (sync ‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏∑‡πà‡∏ô)
   * - ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏Ñ‡πà‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
   */
  mergeCards(localCards, cloudCards) {
    if (!cloudCards || cloudCards.length === 0) return localCards || [];
    if (!localCards || localCards.length === 0) return cloudCards;

    const merged = new Map();
    
    // 1. ‡πÄ‡∏û‡∏¥‡πà‡∏° cloud cards ‡∏Å‡πà‡∏≠‡∏ô
    cloudCards.forEach(card => {
      merged.set(card.id, { ...card });
    });
    
    // 2. ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö local cards
    localCards.forEach(localCard => {
      const cloudCard = merged.get(localCard.id);
      
      if (!cloudCard) {
        // Card ‡∏°‡∏µ‡πÅ‡∏Ñ‡πà‡πÉ‡∏ô local ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
        merged.set(localCard.id, localCard);
      } else {
        // ‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ó‡∏µ‡πà ‚Üí ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà‡∏Å‡∏ß‡πà‡∏≤
        const localTime = localCard.lastModified || 0;
        const cloudTime = cloudCard.lastModified || 0;
        
        if (localTime >= cloudTime) {
          // ‚úÖ Local ‡πÉ‡∏´‡∏°‡πà‡∏Å‡∏ß‡πà‡∏≤ ‚Üí ‡πÉ‡∏ä‡πâ local (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô progress ‡∏´‡∏≤‡∏¢)
          merged.set(localCard.id, localCard);
          console.log(`[Merge] Keep local: ${localCard.front} (local: ${localTime}, cloud: ${cloudTime})`);
        } else {
          // Cloud ‡πÉ‡∏´‡∏°‡πà‡∏Å‡∏ß‡πà‡∏≤ ‚Üí ‡πÉ‡∏ä‡πâ cloud
          console.log(`[Merge] Use cloud: ${cloudCard.front} (local: ${localTime}, cloud: ${cloudTime})`);
        }
      }
    });
    
    return Array.from(merged.values());
  },

  // Merge decks
  mergeDecks(localDecks, cloudDecks) {
    if (!cloudDecks || cloudDecks.length === 0) return localDecks || [];
    if (!localDecks || localDecks.length === 0) return cloudDecks;

    const merged = new Map();
    
    cloudDecks.forEach(deck => merged.set(deck.id, { ...deck }));
    
    localDecks.forEach(localDeck => {
      const cloudDeck = merged.get(localDeck.id);
      if (!cloudDeck) {
        merged.set(localDeck.id, localDeck);
      } else {
        const localTime = localDeck.lastModified || new Date(localDeck.createdAt || 0).getTime();
        const cloudTime = cloudDeck.lastModified || new Date(cloudDeck.createdAt || 0).getTime();
        if (localTime >= cloudTime) {
          merged.set(localDeck.id, localDeck);
        }
      }
    });
    
    return Array.from(merged.values());
  },

  // Merge reviews - ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥
  mergeReviews(localReviews, cloudReviews) {
    if (!cloudReviews || cloudReviews.length === 0) return localReviews || [];
    if (!localReviews || localReviews.length === 0) return cloudReviews;

    const merged = new Map();
    
    [...cloudReviews, ...localReviews].forEach(review => {
      const key = `${review.cardId}_${review.date}`;
      merged.set(key, review);
    });
    
    return Array.from(merged.values());
  },

  // Merge stats - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤
  mergeStats(localStats, cloudStats) {
    if (!cloudStats) return localStats || { streak: 0, totalReviews: 0 };
    if (!localStats) return cloudStats;

    return {
      streak: Math.max(localStats.streak || 0, cloudStats.streak || 0),
      totalReviews: Math.max(localStats.totalReviews || 0, cloudStats.totalReviews || 0),
      lastGoalDate: (localStats.lastGoalDate || '') > (cloudStats.lastGoalDate || '')
        ? localStats.lastGoalDate 
        : cloudStats.lastGoalDate,
    };
  }
};

// ============================================
// CUSTOM LOGO COMPONENT
// ============================================
const Logo = ({ size = 32, className = '' }) => (
  <svg width={size} height={size} viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg" className={className}>
    <defs>
      <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#F97316" />
        <stop offset="100%" stopColor="#EAB308" />
      </linearGradient>
      <linearGradient id="logoGradientLight" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="#FDBA74" />
        <stop offset="100%" stopColor="#FDE047" />
      </linearGradient>
    </defs>
    <path d="M8 12C8 10.3431 9.34315 9 11 9H22C23.1046 9 24 9.89543 24 11V38C24 38 20 36 15 36C10 36 8 38 8 38V12Z" 
      fill="url(#logoGradientLight)" stroke="url(#logoGradient)" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/>
    <path d="M40 12C40 10.3431 38.6569 9 37 9H26C24.8954 9 24 9.89543 24 11V38C24 38 28 36 33 36C38 36 40 38 40 38V12Z" 
      fill="url(#logoGradientLight)" stroke="url(#logoGradient)" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/>
    <path d="M24 11V38" stroke="url(#logoGradient)" strokeWidth="2" strokeLinecap="round"/>
    <path d="M12 16H20" stroke="url(#logoGradient)" strokeWidth="2" strokeLinecap="round"/>
    <path d="M12 22H18" stroke="url(#logoGradient)" strokeWidth="2" strokeLinecap="round"/>
    <path d="M28 16H36" stroke="url(#logoGradient)" strokeWidth="2" strokeLinecap="round"/>
    <path d="M30 22H36" stroke="url(#logoGradient)" strokeWidth="2" strokeLinecap="round"/>
    <circle cx="38" cy="8" r="2" fill="#F97316"/>
    <circle cx="42" cy="12" r="1.5" fill="#EAB308"/>
  </svg>
);

// ============================================
// AI SERVICE - Gemini 2.5 with JSON Mode
// ============================================
const AIService = {
  async callGemini(prompt, apiKey) {
    const body = {
      contents: [{ parts: [{ text: prompt }] }],
      generationConfig: {
        temperature: 0.7,
        maxOutputTokens: 2048,
        responseMimeType: "application/json",
      }
    };

    try {
      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        }
      );

      if (!response.ok) {
        if (response.status === 400) throw new Error('API Key invalid');
        if (response.status === 403) throw new Error('Quota exceeded');
        if (response.status === 429) throw new Error('Rate limit - wait and retry');
        throw new Error(`HTTP ${response.status}`);
      }

      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
      if (!text) throw new Error('Empty response');
      
      try {
        return JSON.parse(text);
      } catch {
        const jsonMatch = text.match(/\{[\s\S]*\}|\[[\s\S]*\]/);
        if (jsonMatch) return JSON.parse(jsonMatch[0]);
        throw new Error('Invalid JSON');
      }
    } catch (error) {
      console.error('AI Error:', error);
      throw error;
    }
  },

  async getAIHelp(word, meaning, apiKey) {
    const prompt = `For "${word}" (${meaning}), return JSON: {"example":"sentence","partOfSpeech":"type","memoryTip":"tip","collocations":["phrase1","phrase2"]}`;
    return await this.callGemini(prompt, apiKey);
  },

  async generateDeck(topic, count, level, apiKey) {
    const prompt = `Generate ${count} TOEIC words about "${topic}" at ${level} level. Return JSON: {"words":[{"front":"word","back":"‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•‡πÑ‡∏ó‡∏¢","phonetic":"/phonetic/","example":"sentence"}]}`;
    return await this.callGemini(prompt, apiKey);
  },

  async checkSentence(word, sentence, apiKey) {
    const prompt = `Check sentence using "${word}": "${sentence}". Return JSON: {"grammarCorrect":true/false,"grammarNote":"Thai explanation","contextCorrect":true/false,"contextNote":"Thai","correctedSentence":"corrected","suggestion":"Thai tips","score":1-5}`;
    return await this.callGemini(prompt, apiKey);
  }
};

// ============================================
// ICON COMPONENT
// ============================================
const Icon = ({ name, size = 24, className = '', fill = 'none' }) => {
  const ref = useRef(null);
  useEffect(() => {
    if (!ref.current || !window.lucide) return;
    const pascalName = name.split('-').map(p => p.charAt(0).toUpperCase() + p.slice(1)).join('');
    const iconData = window.lucide.icons[pascalName] || window.lucide.icons[name];
    if (iconData) {
      ref.current.innerHTML = '';
      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      svg.setAttribute('width', size);
      svg.setAttribute('height', size);
      svg.setAttribute('viewBox', '0 0 24 24');
      svg.setAttribute('fill', fill);
      svg.setAttribute('stroke', 'currentColor');
      svg.setAttribute('stroke-width', '2');
      svg.setAttribute('stroke-linecap', 'round');
      svg.setAttribute('stroke-linejoin', 'round');
      if (Array.isArray(iconData)) {
        const children = Array.isArray(iconData[2]) ? iconData[2] : [];
        children.forEach(([tag, attrs]) => {
          const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
          Object.entries(attrs).forEach(([k, v]) => el.setAttribute(k, v));
          svg.appendChild(el);
        });
      }
      ref.current.appendChild(svg);
    }
  }, [name, size, fill]);
  return <span ref={ref} className={`inline-flex items-center justify-center ${className}`} />;
};

// ============================================
// CLOUD SYNC SERVICE
// ============================================
const CloudSync = {
  db: null, auth: null, userId: null, customKey: null, initialized: false, activeListener: null,
   
  init(config) {
    if (this.initialized) return Promise.resolve(true);
    try {
      if (!firebase.apps.length) firebase.initializeApp(config);
      this.db = firebase.database();
      this.auth = firebase.auth();
      this.initialized = true;
      this.customKey = localStorage.getItem('vocab_sync_key');
      return this.signIn();
    } catch (e) { console.error('Firebase init error:', e); return Promise.resolve(false); }
  },
   
  async signIn() {
    try {
      const res = await this.auth.signInAnonymously();
      this.userId = res.user.uid;
      return true;
    } catch (e) { console.error('Auth error:', e); return false; }
  },
   
  setSyncKey(key) {
    this.cleanupListener();
    const cleanKey = key ? key.trim().replace(/[.#$\/\[\]]/g, '_') : null;
    this.customKey = cleanKey;
    if (cleanKey) localStorage.setItem('vocab_sync_key', cleanKey);
    else localStorage.removeItem('vocab_sync_key');
  },

  getUserPath() {
    const pathId = this.customKey || this.userId;
    return pathId ? `users/${pathId}` : null;
  },
   
  getCurrentId() { return this.customKey || this.userId; },

  async saveToCloud(data, onError) {
    const path = this.getUserPath();
    if (!this.initialized || !path) return;
    try { 
      await this.db.ref(path).set({ ...data, lastSync: Date.now() }); 
      console.log('[Cloud] Saved successfully');
    } catch(e) { 
      console.error("Save failed:", e); 
      if(e.code === 'PERMISSION_DENIED' && onError) onError('Permission Denied');
    }
  },
   
  cleanupListener() {
    if (this.activeListener) { this.activeListener.off(); this.activeListener = null; }
  },
   
  onDataChange(cb, onError) {
    const path = this.getUserPath();
    if (!this.initialized || !path) return () => {};
    this.cleanupListener();
    const ref = this.db.ref(path);
    this.activeListener = ref;
     
    const handler = (snapshot) => {
      if (snapshot.exists()) cb(snapshot.val());
      else cb(null);
    };
    const errorHandler = (err) => {
      if(err.code === 'PERMISSION_DENIED' && onError) onError('Permission Denied');
    };
     
    ref.on('value', handler, errorHandler);
    return () => { ref.off('value', handler); this.activeListener = null; };
  },
};

// ============================================
// LOCAL DATABASE
// ============================================
const DB = {
  get: (k, def) => { try { return JSON.parse(localStorage.getItem(`vocab_${k}`)) || def; } catch { return def; } },
  set: (k, v) => localStorage.setItem(`vocab_${k}`, JSON.stringify(v)),
  getApiKey: () => localStorage.getItem('vocab_api_key') || '',
  setApiKey: (k) => localStorage.setItem('vocab_api_key', k),
};

// ============================================
// UTILITIES
// ============================================
const speak = (text) => {
  if (!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'en-US';
  u.rate = 0.9;
  window.speechSynthesis.speak(u);
};

const parseCSV = (txt) => {
  return txt.trim().split('\n').map(l => {
    const p = l.split(','); 
    if(p.length < 2) return null;
    return { front: p[0].trim(), back: p[1].trim(), phonetic: p[2]?.trim()||'', example: p[3]?.trim()||'' };
  }).filter(x => x);
};

const exportToCSV = (cards, deckTitle) => {
  const header = 'word,meaning,phonetic,example\n';
  const rows = cards.map(c => `"${c.front}","${c.back}","${c.phonetic || ''}","${c.example || ''}"`).join('\n');
  const blob = new Blob([header + rows], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `${deckTitle.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
  link.click();
  URL.revokeObjectURL(url);
};

// ============================================
// SRS ALGORITHM - with lastModified
// ============================================
const SRS = {
  // Initialize new card - due NOW + timestamp
  init() {
    return {
      repetitions: 0,
      intervalIndex: 0,
      easeFactor: CONFIG.DEFAULT_EASE,
      nextReviewAt: new Date().toISOString(),
      lastModified: Date.now()  // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° timestamp
    };
  },
   
  // Calculate next review + update timestamp
  calculate(card, q) {
    let { repetitions = 0, intervalIndex = 0, easeFactor = 2.5 } = card;
     
    if (q < 2) { 
      repetitions = 0; 
      intervalIndex = 0; 
    } else {
      repetitions++;
      if (repetitions === 1) intervalIndex = 0;
      else if (repetitions === 2) intervalIndex = 1;
      else intervalIndex = Math.min(intervalIndex + 1, 4);
    }
     
    const eq = q + 2;
    easeFactor = Math.max(1.3, easeFactor + (0.1 - (5 - eq) * (0.08 + (5 - eq) * 0.02)));
    if (q === 3) intervalIndex = Math.min(intervalIndex + 1, 4);
     
    const nextDate = new Date();
    nextDate.setDate(nextDate.getDate() + CONFIG.INTERVALS[intervalIndex]);
     
    return { 
      repetitions, 
      intervalIndex, 
      easeFactor, 
      nextReviewAt: nextDate.toISOString(),
      lastModified: Date.now()  // ‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó timestamp ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏≠‡∏ö
    };
  },
   
  isDue: (c) => !c.nextReviewAt || new Date(c.nextReviewAt) <= new Date()
};

const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

const DECK_COLORS = ['primary', 'mint', 'lavender', 'sky'];
const getColorClasses = (color) => {
  const colors = {
    primary: { bg: 'bg-orange-50', border: 'border-orange-200', text: 'text-primary', dot: 'bg-primary' },
    mint: { bg: 'bg-emerald-50', border: 'border-emerald-200', text: 'text-mint', dot: 'bg-mint' },
    lavender: { bg: 'bg-violet-50', border: 'border-violet-200', text: 'text-lavender', dot: 'bg-lavender' },
    sky: { bg: 'bg-sky-50', border: 'border-sky-200', text: 'text-sky', dot: 'bg-sky' },
  };
  return colors[color] || colors.primary;
};

// ============================================
// COMPONENTS
// ============================================
const ConfirmDialog = ({ isOpen, title, message, onConfirm, onCancel, type = 'danger' }) => {
  if (!isOpen) return null;
  const colors = {
    danger: { btn: 'bg-coral hover:bg-red-600 text-white', icon: 'trash-2', iconBg: 'bg-red-100', iconColor: 'text-coral' },
    warning: { btn: 'bg-gold hover:bg-amber-600 text-white', icon: 'alert-triangle', iconBg: 'bg-amber-100', iconColor: 'text-gold' },
  };
  return (
    <div className="fixed inset-0 z-[60] modal-backdrop flex items-center justify-center p-4" onClick={onCancel}>
      <div className="bg-white rounded-3xl p-6 w-full max-w-sm shadow-elevated animate-scale-in" onClick={e => e.stopPropagation()}>
        <div className={`w-16 h-16 rounded-2xl ${colors[type].iconBg} flex items-center justify-center mx-auto mb-4`}>
          <Icon name={colors[type].icon} size={28} className={colors[type].iconColor} />
        </div>
        <h3 className="text-xl font-bold text-heading text-center mb-2">{title}</h3>
        <p className="text-body text-center mb-6">{message}</p>
        <div className="flex gap-3">
          <button onClick={onCancel} className="flex-1 btn-secondary py-3 rounded-xl">Cancel</button>
          <button onClick={onConfirm} className={`flex-1 ${colors[type].btn} py-3 rounded-xl font-semibold`}>Confirm</button>
        </div>
      </div>
    </div>
  );
};

const OfflineIndicator = ({ isOffline }) => {
  if (!isOffline) return null;
  return (
    <div className="fixed top-20 left-1/2 -translate-x-1/2 z-50 animate-slide-up">
      <div className="bg-coral text-white px-4 py-2 rounded-full flex items-center gap-2 text-sm font-semibold shadow-lg">
        <Icon name="wifi-off" size={16} /> Offline Mode
      </div>
    </div>
  );
};

const SearchBar = ({ value, onChange, placeholder }) => (
  <div className="relative">
    <Icon name="search" size={20} className="absolute left-4 top-1/2 -translate-y-1/2 text-muted" />
    <input type="text" value={value} onChange={e => onChange(e.target.value)} placeholder={placeholder}
      className="w-full input-clean pl-12 pr-10 py-3 rounded-xl text-heading placeholder-muted" />
    {value && (
      <button onClick={() => onChange('')} className="absolute right-4 top-1/2 -translate-y-1/2 text-muted hover:text-body">
        <Icon name="x" size={18} />
      </button>
    )}
  </div>
);

const CircularProgress = ({ value, max, size = 80 }) => {
  const radius = (size - 8) / 2;
  const circumference = 2 * Math.PI * radius;
  const progress = Math.min(value / max, 1);
  const offset = circumference - (progress * circumference);
   
  return (
    <div className="relative" style={{ width: size, height: size }}>
      <svg className="w-full h-full transform -rotate-90">
        <circle cx={size/2} cy={size/2} r={radius} stroke="#F1F5F9" strokeWidth="8" fill="none"/>
        <circle cx={size/2} cy={size/2} r={radius} stroke="url(#progressGradient)" strokeWidth="8" fill="none"
          strokeDasharray={circumference} strokeDashoffset={offset} strokeLinecap="round" className="transition-all duration-1000 ease-out"/>
        <defs>
          <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stopColor="#F97316" /><stop offset="100%" stopColor="#EAB308" />
          </linearGradient>
        </defs>
      </svg>
      <div className="absolute inset-0 flex items-center justify-center">
        <span className="text-xl font-bold text-heading">{value}<span className="text-sm text-muted">/{max}</span></span>
      </div>
    </div>
  );
};

const SentenceCheckPanel = ({ word, apiKey, onClose }) => {
  const [sentence, setSentence] = useState('');
  const [checking, setChecking] = useState(false);
  const [result, setResult] = useState(null);
  const [error, setError] = useState('');

  const handleCheck = async () => {
    if (!sentence.trim() || !apiKey) return;
    setChecking(true); setError(''); setResult(null);
    try {
      setResult(await AIService.checkSentence(word, sentence, apiKey));
    } catch (err) { setError(err.message); }
    setChecking(false);
  };

  return (
    <div className="bg-violet-50 rounded-2xl p-4 border border-violet-100 mt-4 animate-fade-in">
      <div className="flex items-center justify-between mb-3">
        <h4 className="font-semibold text-lavender flex items-center gap-2">
          <Icon name="pen-tool" size={18} /> Practice Writing
        </h4>
        <button onClick={onClose} className="text-muted hover:text-body"><Icon name="x" size={18} /></button>
      </div>
       
      <p className="text-sm text-body mb-3">‡∏•‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "<span className="font-semibold text-lavender">{word}</span>"</p>
       
      <textarea value={sentence} onChange={e => setSentence(e.target.value)}
        placeholder={`Type a sentence using "${word}"...`}
        className="w-full input-clean p-3 rounded-xl text-heading text-sm resize-none h-20 mb-3" />
       
      <button onClick={handleCheck} disabled={checking || !sentence.trim()}
        className="w-full btn-ai py-2.5 rounded-xl flex items-center justify-center gap-2 disabled:opacity-50">
        {checking ? <><Icon name="loader-2" size={18} className="animate-spin" /> Checking...</> : <><Icon name="sparkles" size={18} /> Check with AI</>}
      </button>

      {error && <div className="mt-3 p-3 bg-red-50 border border-red-200 rounded-xl"><p className="text-sm text-coral">{error}</p></div>}

      {result && (
        <div className="mt-4 space-y-3 animate-fade-in">
          <div className="flex items-center justify-between">
            <span className="text-sm font-medium text-body">Score</span>
            <div className="flex gap-1">
              {[1,2,3,4,5].map(i => (
                <Icon key={i} name="star" size={18} fill={i <= result.score ? '#F59E0B' : 'none'} 
                  className={i <= result.score ? 'text-gold' : 'text-slate-300'} />
              ))}
            </div>
          </div>
           
          <div className={`p-3 rounded-xl ${result.grammarCorrect ? 'bg-emerald-50 border border-emerald-200' : 'bg-red-50 border border-red-200'}`}>
            <div className="flex items-center gap-2 mb-1">
              <Icon name={result.grammarCorrect ? 'check-circle' : 'x-circle'} size={16} className={result.grammarCorrect ? 'text-mint' : 'text-coral'} />
              <span className="text-sm font-medium">Grammar</span>
            </div>
            <p className="text-sm text-body">{result.grammarNote}</p>
          </div>
           
          <div className={`p-3 rounded-xl ${result.contextCorrect ? 'bg-emerald-50 border border-emerald-200' : 'bg-amber-50 border border-amber-200'}`}>
            <div className="flex items-center gap-2 mb-1">
              <Icon name={result.contextCorrect ? 'check-circle' : 'alert-circle'} size={16} className={result.contextCorrect ? 'text-mint' : 'text-gold'} />
              <span className="text-sm font-medium">Context</span>
            </div>
            <p className="text-sm text-body">{result.contextNote}</p>
          </div>
           
          {result.correctedSentence && result.correctedSentence !== sentence && (
            <div className="p-3 bg-sky-50 border border-sky-200 rounded-xl">
              <p className="text-xs text-sky font-medium mb-1">‚ú® Suggested</p>
              <p className="text-sm text-heading italic">"{result.correctedSentence}"</p>
            </div>
          )}
           
          {result.suggestion && (
            <div className="p-3 bg-violet-50 border border-violet-200 rounded-xl">
              <p className="text-xs text-lavender font-medium mb-1">üí° Tips</p>
              <p className="text-sm text-body">{result.suggestion}</p>
            </div>
          )}
        </div>
      )}
    </div>
  );
};

// ============================================
// MAIN APP
// ============================================
function App() {
  const [view, setView] = useState('home');
  const [decks, setDecks] = useState([]);
  const [cards, setCards] = useState([]);
  const [reviews, setReviews] = useState([]);
  const [stats, setStats] = useState({ streak: 0, totalReviews: 0 });
   
  const [apiKey, setApiKey] = useState('');
  const [cloudEnabled, setCloudEnabled] = useState(false);
  const [syncing, setSyncing] = useState(false);
  const [currentSyncKey, setCurrentSyncKey] = useState('');
  const [isOffline, setIsOffline] = useState(!navigator.onLine);
  const [isLoading, setIsLoading] = useState(true);
   
  const syncTimer = useRef(null);
  const lastSaveTime = useRef(0);
  const SYNC_LOCK_DURATION = 5000;  // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

  // ‚úÖ Refs ‡πÄ‡∏Å‡πá‡∏ö current state ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡πÉ‡∏ô merge
  const cardsRef = useRef(cards);
  const decksRef = useRef(decks);
  const reviewsRef = useRef(reviews);
  const statsRef = useRef(stats);

  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó refs ‡πÄ‡∏°‡∏∑‡πà‡∏≠ state ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
  useEffect(() => { cardsRef.current = cards; }, [cards]);
  useEffect(() => { decksRef.current = decks; }, [decks]);
  useEffect(() => { reviewsRef.current = reviews; }, [reviews]);
  useEffect(() => { statsRef.current = stats; }, [stats]);

  const [selDeck, setSelDeck] = useState(null);
  const [studyQ, setStudyQ] = useState([]);
  const [currCard, setCurrCard] = useState(0);
  const [flipped, setFlipped] = useState(false);
  const [aiLoading, setAiLoading] = useState(false);
  const [aiData, setAiData] = useState(null);
  const [searchQuery, setSearchQuery] = useState('');
  const [showPractice, setShowPractice] = useState(false);

  const [modals, setModals] = useState({ 
    addDeck: false, addCard: false, import: false, settings: false, editCard: false, generateDeck: false 
  });
  const [confirmDialog, setConfirmDialog] = useState({ isOpen: false });
  const [editingCard, setEditingCard] = useState(null);
  const [toast, setToast] = useState(null);
   
  const [genTopic, setGenTopic] = useState('');
  const [genCount, setGenCount] = useState(10);
  const [genLevel, setGenLevel] = useState('Intermediate');
  const [generating, setGenerating] = useState(false);

  const notify = (msg, type = 'success') => { 
    setToast({ msg, type }); 
    setTimeout(() => setToast(null), 4000); 
  };

  // Online/Offline
  useEffect(() => {
    const handleOnline = () => { setIsOffline(false); notify('Back online!'); };
    const handleOffline = () => { setIsOffline(true); notify('You are offline', 'warning'); };
    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);
    return () => { window.removeEventListener('online', handleOnline); window.removeEventListener('offline', handleOffline); };
  }, []);

  // Initial Load - ‡πÄ‡∏û‡∏¥‡πà‡∏° lastModified ‡πÉ‡∏´‡πâ cards ‡πÄ‡∏Å‡πà‡∏≤
  useEffect(() => {
    const loadData = async () => {
      setIsLoading(true);
      const localDecks = DB.get('decks', []);
      const localCards = DB.get('cards', []);
       
      if (localDecks.length === 0) {
        const starterCards = STARTER_CARDS.map(c => ({ ...c, id: generateId(), deckId: STARTER_DECK.id, ...SRS.init() }));
        setDecks([STARTER_DECK]);
        setCards(starterCards);
      } else {
        // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° lastModified ‡πÉ‡∏´‡πâ cards ‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
        const updatedDecks = localDecks.map(d => ({
          ...d,
          lastModified: d.lastModified || Date.now()
        }));
        const updatedCards = localCards.map(c => ({
          ...c,
          lastModified: c.lastModified || Date.now()
        }));
        setDecks(updatedDecks);
        setCards(updatedCards);
      }
       
      setReviews(DB.get('reviews', []));
      setStats(DB.get('stats', { streak: 0, totalReviews: 0 }));
      setApiKey(DB.getApiKey());
       
      if (navigator.onLine) await initCloud(FIREBASE_CONFIG);
      setTimeout(() => setIsLoading(false), 600);
    };
    loadData();
  }, []);

  const initCloud = async (cfg) => {
    if (await CloudSync.init(cfg)) {
      setCloudEnabled(true);
      setCurrentSyncKey(CloudSync.getCurrentId() || '');
    }
  };

  // ============================================
  // üî• SMART SYNC - Realtime Subscription with Merge
  // ============================================
  const unsubscribeRef = useRef(null);
  useEffect(() => {
    if (unsubscribeRef.current) { unsubscribeRef.current(); unsubscribeRef.current = null; }
    if (!cloudEnabled || isOffline) return;

    const timeoutId = setTimeout(() => {
      setSyncing(true);
      unsubscribeRef.current = CloudSync.onDataChange(
        (cloudData) => {
          const timeSinceLastSave = Date.now() - lastSaveTime.current;
          
          // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á save ‡πÑ‡∏õ ‚Üí ignore (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô loop)
          if (timeSinceLastSave < SYNC_LOCK_DURATION) { 
            console.log(`[Sync] Ignoring cloud update (lock: ${timeSinceLastSave}ms)`);
            setSyncing(false); 
            return; 
          }
          
          if (!cloudData) {
            console.log('[Sync] No cloud data');
            setSyncing(false);
            return;
          }

          console.log('[Sync] üîÑ Merging cloud data with local...');
          
          // ‚úÖ ‡πÉ‡∏ä‡πâ Smart Merge ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö
          const mergedCards = SmartMerge.mergeCards(cardsRef.current, cloudData.cards);
          const mergedDecks = SmartMerge.mergeDecks(decksRef.current, cloudData.decks);
          const mergedReviews = SmartMerge.mergeReviews(reviewsRef.current, cloudData.reviews);
          const mergedStats = SmartMerge.mergeStats(statsRef.current, cloudData.stats);

          // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó state
          setCards(mergedCards);
          setDecks(mergedDecks);
          setReviews(mergedReviews);
          setStats(mergedStats);

          // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å local
          DB.set('cards', mergedCards);
          DB.set('decks', mergedDecks);
          DB.set('reviews', mergedReviews);
          DB.set('stats', mergedStats);

          console.log('[Sync] ‚úÖ Merge complete');
          setSyncing(false);
        },
        (err) => { setSyncing(false); notify(err, 'error'); }
      );
    }, 100);
    return () => { clearTimeout(timeoutId); if (unsubscribeRef.current) unsubscribeRef.current(); };
  }, [cloudEnabled, currentSyncKey, isOffline]);

  // Auto Save with debounce
  const saveData = useCallback(() => {
    DB.set('decks', decks); 
    DB.set('cards', cards); 
    DB.set('reviews', reviews); 
    DB.set('stats', stats);
    
    if (cloudEnabled && !isOffline) {
      clearTimeout(syncTimer.current);
      syncTimer.current = setTimeout(() => {
        lastSaveTime.current = Date.now();
        console.log('[Save] üíæ Saving to cloud...');
        CloudSync.saveToCloud({ decks, cards, reviews, stats }, (err) => notify(err, 'error'));
      }, 1500);  // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° debounce ‡πÄ‡∏õ‡πá‡∏ô 1.5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    }
  }, [decks, cards, reviews, stats, cloudEnabled, isOffline]);

  useEffect(() => { if (!isLoading) saveData(); }, [decks, cards, reviews, stats, isLoading]);

  useEffect(() => {
    document.body.classList.toggle('modal-open', Object.values(modals).some(v => v) || confirmDialog.isOpen);
  }, [modals, confirmDialog]);

  const toggleModal = (n, v) => setModals(prev => ({ ...prev, [n]: v }));

  // ============================================
  // ACTIONS - ‡πÄ‡∏û‡∏¥‡πà‡∏° lastModified ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
  // ============================================
   
  const createDeck = (title) => {
    const color = DECK_COLORS[decks.length % DECK_COLORS.length];
    setDecks([...decks, { 
      id: generateId(), 
      title, 
      createdAt: new Date().toISOString(), 
      color,
      lastModified: Date.now()  // ‚úÖ
    }]);
    toggleModal('addDeck', false);
    notify('Deck created! üéâ');
  };

  const deleteDeck = (deckId) => {
    setConfirmDialog({
      isOpen: true, type: 'danger', title: 'Delete Deck?',
      message: 'This will permanently delete the deck and all its cards.',
      onConfirm: () => {
        setDecks(decks.filter(d => d.id !== deckId));
        setCards(cards.filter(c => c.deckId !== deckId));
        setConfirmDialog({ isOpen: false });
        setView('library');
        notify('Deck deleted');
      }
    });
  };

  const addCard = (data) => {
    setCards([...cards, { 
      id: generateId(), 
      deckId: selDeck.id, 
      ...data, 
      ...SRS.init()  // ‚úÖ ‡∏°‡∏µ lastModified ‡πÅ‡∏•‡πâ‡∏ß
    }]);
    toggleModal('addCard', false);
    notify('Card added! ‚ú®');
  };

  const updateCard = (id, data) => {
    setCards(cards.map(c => c.id === id ? { 
      ...c, 
      ...data, 
      lastModified: Date.now()  // ‚úÖ
    } : c));
    toggleModal('editCard', false);
    setEditingCard(null);
    notify('Card updated');
  };

  const deleteCard = (id) => {
    setConfirmDialog({
      isOpen: true, type: 'danger', title: 'Delete Card?',
      message: 'This card will be permanently removed.',
      onConfirm: () => {
        setCards(cards.filter(c => c.id !== id));
        setConfirmDialog({ isOpen: false });
        notify('Card deleted');
      }
    });
  };

  const importCSV = (txt) => {
    const newCards = parseCSV(txt).map(c => ({ 
      id: generateId(), 
      deckId: selDeck.id, 
      ...c, 
      ...SRS.init()  // ‚úÖ ‡∏°‡∏µ lastModified
    }));
    if (newCards.length) {
      setCards([...cards, ...newCards]);
      toggleModal('import', false);
      notify(`Imported ${newCards.length} cards! üìö`);
    } else notify('No valid cards found', 'error');
  };

  const handleExport = () => {
    const deckCards = cards.filter(c => c.deckId === selDeck.id);
    if (deckCards.length === 0) { notify('No cards to export', 'warning'); return; }
    exportToCSV(deckCards, selDeck.title);
    notify('Exported! üì§');
  };

  const handleGenerateDeck = async () => {
    if (!genTopic.trim()) { notify('Please enter a topic', 'warning'); return; }
    if (!apiKey) { notify('Add API Key first', 'warning'); toggleModal('generateDeck', false); toggleModal('settings', true); return; }
     
    setGenerating(true);
    try {
      const result = await AIService.generateDeck(genTopic, genCount, genLevel, apiKey);
       
      let wordsArray = null;
      if (Array.isArray(result)) wordsArray = result;
      else if (result.words) wordsArray = result.words;
      else if (result.vocabulary) wordsArray = result.vocabulary;
      else {
        for (const key of Object.keys(result)) {
          if (Array.isArray(result[key])) { wordsArray = result[key]; break; }
        }
      }

      if (!wordsArray?.length) throw new Error('Invalid AI response');

      const newDeckId = generateId();
      const newDeck = {
        id: newDeckId,
        title: `${genTopic} (AI)`,
        createdAt: new Date().toISOString(),
        color: DECK_COLORS[decks.length % 4],
        isAIGenerated: true,
        lastModified: Date.now()  // ‚úÖ
      };

      const newCards = wordsArray.map(w => ({
        id: generateId(),
        deckId: newDeckId,
        front: w.front || w.word || '',
        back: w.back || w.meaning || w.thai || '',
        phonetic: w.phonetic || '',
        example: w.example || '',
        ...SRS.init()  // ‚úÖ ‡∏°‡∏µ lastModified
      })).filter(c => c.front && c.back);

      if (!newCards.length) throw new Error('No valid cards');

      setDecks([...decks, newDeck]);
      setCards([...cards, ...newCards]);
      toggleModal('generateDeck', false);
      setGenTopic('');
      notify(`Generated ${newCards.length} cards! ‚ú®`);
      setSelDeck(newDeck);
      setView('deck');
    } catch (err) {
      notify(err.message || 'Generation failed', 'error');
    }
    setGenerating(false);
  };

  const startStudy = (deckId = null) => {
    const pool = deckId ? cards.filter(c => c.deckId === deckId && SRS.isDue(c)) : cards.filter(SRS.isDue);
    if (!pool.length) { notify('No cards due!', 'info'); return; }
    setStudyQ(pool.sort(() => Math.random() - 0.5));
    setCurrCard(0); setFlipped(false); setAiData(null); setShowPractice(false); setView('study');
  };

  // ‚úÖ handleReview - SRS.calculate ‡∏°‡∏µ lastModified ‡πÅ‡∏•‡πâ‡∏ß
  const handleReview = (q) => {
    const c = studyQ[currCard];
    const updated = SRS.calculate(c, q);  // ‚úÖ ‡∏°‡∏µ lastModified
    
    setCards(cards.map(x => x.id === c.id ? { ...x, ...updated } : x));
    setReviews([...reviews, { cardId: c.id, q, date: new Date().toISOString() }]);
     
    const today = new Date().toDateString();
    const todayReviews = reviews.filter(r => new Date(r.date).toDateString() === today).length + 1;
    if (todayReviews >= CONFIG.DAILY_GOAL && stats.lastGoalDate !== today) {
      setStats(prev => ({ ...prev, streak: prev.streak + 1, totalReviews: prev.totalReviews + 1, lastGoalDate: today }));
    } else {
      setStats(prev => ({ ...prev, totalReviews: prev.totalReviews + 1 }));
    }
     
    if (currCard < studyQ.length - 1) {
      setCurrCard(currCard + 1); setFlipped(false); setAiData(null); setShowPractice(false);
    } else { notify('Session complete! üéâ'); setView('home'); }
  };

  const handleAI = async () => {
    if (!apiKey) { toggleModal('settings', true); notify('Add API key first', 'warning'); return; }
    setAiLoading(true);
    try {
      const data = await AIService.getAIHelp(studyQ[currCard].front, studyQ[currCard].back, apiKey);
      setAiData(data);
      if (!studyQ[currCard].example && data.example) {
        setCards(cards.map(x => x.id === studyQ[currCard].id ? { 
          ...x, 
          example: data.example, 
          lastModified: Date.now()  // ‚úÖ
        } : x));
      }
    } catch (e) { notify(e.message || 'AI failed', 'error'); }
    setAiLoading(false);
  };

  const updateSyncKey = (newKey) => {
    const cleanKey = newKey?.trim();
    if (!cleanKey) { notify('Enter a sync key', 'warning'); return; }
    CloudSync.setSyncKey(cleanKey);
    setCurrentSyncKey(cleanKey);
    notify('Sync key updated! Reloading...');
    setTimeout(() => window.location.reload(), 1000);
  };

  // Computed
  const dueCount = useMemo(() => cards.filter(SRS.isDue).length, [cards]);
  const todayProgress = useMemo(() => {
    const today = new Date().toDateString();
    return Math.min(reviews.filter(r => new Date(r.date).toDateString() === today).length, CONFIG.DAILY_GOAL);
  }, [reviews]);
  const filteredCards = useMemo(() => {
    if (!selDeck) return [];
    const dc = cards.filter(c => c.deckId === selDeck.id);
    if (!searchQuery) return dc;
    const q = searchQuery.toLowerCase();
    return dc.filter(c => c.front.toLowerCase().includes(q) || c.back.toLowerCase().includes(q));
  }, [cards, selDeck, searchQuery]);

  // Loading
  if (isLoading) {
    return (
      <div className="min-h-screen bg-cream flex flex-col items-center justify-center p-4">
        <div className="animate-float mb-6"><Logo size={80} /></div>
        <h1 className="text-2xl font-bold gradient-text mb-2">VocabLab</h1>
        <p className="text-muted mb-6">Loading...</p>
        <div className="w-48 h-1.5 bg-slate-200 rounded-full overflow-hidden">
          <div className="h-full bg-gradient-to-r from-primary to-gold rounded-full skeleton" style={{ width: '70%' }}></div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-cream text-heading pb-safe">
      <OfflineIndicator isOffline={isOffline} />
       
      {/* Header */}
      <header className="fixed top-0 w-full bg-white/80 backdrop-blur-lg z-40 pt-safe px-4 pb-3 border-b border-slate-100">
        <div className="flex justify-between items-center max-w-lg mx-auto">
          <button onClick={() => setView('home')} className="flex items-center gap-2">
            <Logo size={32} />
            <h1 className="text-xl font-bold gradient-text">VocabLab</h1>
          </button>
          <div className="flex items-center gap-2">
            {cloudEnabled && (
              <div className={`p-2 rounded-full ${syncing ? 'bg-sky-50' : isOffline ? 'bg-red-50' : 'bg-emerald-50'}`}>
                <Icon name={syncing ? 'loader-2' : isOffline ? 'cloud-off' : 'cloud'} size={18} 
                  className={`${syncing ? 'animate-spin text-sky' : isOffline ? 'text-coral' : 'text-mint'}`} />
              </div>
            )}
            <button onClick={() => toggleModal('settings', true)} className="p-2 rounded-full hover:bg-slate-100">
              <Icon name="settings" size={20} className="text-muted" />
            </button>
          </div>
        </div>
      </header>

      {/* Main */}
      <main className="pt-24 px-4 pb-28 max-w-lg mx-auto">
        
        {/* HOME */}
        {view === 'home' && (
          <div className="animate-fade-in space-y-5">
            <div className="card p-6">
              <div className="flex justify-between items-center">
                <div>
                  <h2 className="text-lg font-semibold text-heading mb-3">Daily Goal</h2>
                  <div className="flex items-center gap-2 bg-orange-50 px-4 py-2 rounded-full">
                    <Icon name="flame" size={18} className="text-primary" />
                    <span className="font-bold text-primary">{stats.streak} Day Streak</span>
                  </div>
                </div>
                <CircularProgress value={todayProgress} max={CONFIG.DAILY_GOAL} />
              </div>
            </div>

            {dueCount > 0 ? (
              <button onClick={() => startStudy()} className="w-full btn-primary py-5 rounded-2xl text-lg flex items-center justify-center gap-3">
                <Icon name="play" size={24} fill="currentColor" /> Study {dueCount} Due Cards
              </button>
            ) : (
              <div className="card p-8 text-center border-2 border-dashed border-emerald-200 bg-emerald-50/50">
                <Icon name="check-circle" size={40} className="text-mint mx-auto mb-3" />
                <h3 className="text-xl font-bold mb-2">All caught up!</h3>
                <p className="text-body">No cards due. Great job! üéâ</p>
              </div>
            )}

            <button onClick={() => toggleModal('generateDeck', true)}
              className="w-full bg-gradient-to-r from-violet-500 to-purple-600 text-white py-4 rounded-2xl font-semibold flex items-center justify-center gap-3 shadow-lg">
              <Icon name="sparkles" size={22} /> Generate Deck with AI
            </button>

            <div className="grid grid-cols-3 gap-3">
              {[
                { value: cards.length, label: 'Cards', color: 'text-primary' },
                { value: decks.length, label: 'Decks', color: 'text-lavender' },
                { value: stats.totalReviews || 0, label: 'Reviews', color: 'text-mint' },
              ].map((s, i) => (
                <div key={i} className="card p-4 text-center">
                  <div className={`text-2xl font-bold ${s.color}`}>{s.value}</div>
                  <div className="text-xs text-muted uppercase mt-1">{s.label}</div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* LIBRARY */}
        {view === 'library' && (
          <div className="animate-fade-in space-y-4">
            <div className="flex justify-between items-center mb-2">
              <h2 className="text-2xl font-bold">My Decks</h2>
              <div className="flex gap-2">
                <button onClick={() => toggleModal('generateDeck', true)} className="p-2.5 btn-ai rounded-full">
                  <Icon name="sparkles" size={20} />
                </button>
                <button onClick={() => toggleModal('addDeck', true)} className="p-2.5 btn-primary rounded-full">
                  <Icon name="plus" size={22} />
                </button>
              </div>
            </div>

            {decks.length === 0 ? (
              <div className="card p-8 text-center border-2 border-dashed">
                <Icon name="folder-plus" size={48} className="text-muted mx-auto mb-4" />
                <p className="text-body">No decks yet</p>
              </div>
            ) : (
              <div className="space-y-3">
                {decks.map((d, idx) => {
                  const colors = getColorClasses(d.color || DECK_COLORS[idx % 4]);
                  const dc = cards.filter(c => c.deckId === d.id);
                  const due = dc.filter(SRS.isDue).length;
                  return (
                    <div key={d.id} onClick={() => { setSelDeck(d); setSearchQuery(''); setView('deck'); }}
                      className="card p-5 cursor-pointer hover:shadow-elevated transition-all active:scale-[0.99]">
                      <div className="flex justify-between items-start">
                        <div className="flex items-start gap-3">
                          <div className={`w-3 h-3 rounded-full ${colors.dot} mt-2`}></div>
                          <div>
                            <div className="flex items-center gap-2">
                              <h3 className="font-bold text-lg">{d.title}</h3>
                              {d.isAIGenerated && <Icon name="sparkles" size={14} className="text-lavender" />}
                            </div>
                            <p className="text-sm text-muted">{dc.length} cards</p>
                          </div>
                        </div>
                        <div className="flex items-center gap-3">
                          {due > 0 && <span className={`${colors.bg} ${colors.text} px-3 py-1 rounded-full text-sm font-semibold`}>{due} due</span>}
                          <Icon name="chevron-right" size={20} className="text-muted" />
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        )}

        {/* DECK VIEW */}
        {view === 'deck' && selDeck && (
          <div className="animate-fade-in space-y-4">
            <button onClick={() => setView('library')} className="flex items-center text-muted gap-1 text-sm hover:text-body">
              <Icon name="arrow-left" size={16} /> Back
            </button>
             
            <div className="flex justify-between items-start mb-4">
              <div>
                <div className="flex items-center gap-2">
                  <h1 className="text-2xl font-bold">{selDeck.title}</h1>
                  {selDeck.isAIGenerated && <span className="bg-violet-100 text-lavender text-xs px-2 py-0.5 rounded-full font-medium">AI</span>}
                </div>
                <p className="text-muted">{cards.filter(c => c.deckId === selDeck.id).length} cards</p>
              </div>
              <div className="flex gap-2">
                <button onClick={handleExport} className="p-2.5 btn-secondary rounded-xl"><Icon name="download" size={18} /></button>
                <button onClick={() => toggleModal('import', true)} className="p-2.5 btn-secondary rounded-xl"><Icon name="upload" size={18} /></button>
                <button onClick={() => toggleModal('addCard', true)} className="p-2.5 btn-primary rounded-xl"><Icon name="plus" size={18} /></button>
              </div>
            </div>

            <SearchBar value={searchQuery} onChange={setSearchQuery} placeholder="Search cards..." />

            {cards.filter(c => c.deckId === selDeck.id && SRS.isDue(c)).length > 0 && (
              <button onClick={() => startStudy(selDeck.id)}
                className="w-full border-2 border-primary text-primary py-3 rounded-xl font-semibold flex items-center justify-center gap-2 hover:bg-orange-50">
                <Icon name="play" size={18} /> Study {cards.filter(c => c.deckId === selDeck.id && SRS.isDue(c)).length} Due
              </button>
            )}

            <div className="space-y-2 pb-10">
              {filteredCards.length === 0 ? (
                <div className="card p-8 text-center">
                  <Icon name="inbox" size={40} className="text-muted mx-auto mb-3" />
                  <p className="text-body">{searchQuery ? 'No matches' : 'No cards yet'}</p>
                </div>
              ) : (
                filteredCards.map(c => (
                  <div key={c.id} className="card p-4 flex justify-between items-start">
                    <div className="flex-1 cursor-pointer" onClick={() => { setEditingCard(c); toggleModal('editCard', true); }}>
                      <div className="font-semibold">{c.front}</div>
                      <div className="text-body">{c.back}</div>
                      {c.phonetic && <div className="text-xs text-muted mt-1">{c.phonetic}</div>}
                    </div>
                    <div className="flex gap-1 ml-3">
                      <button onClick={(e) => { e.stopPropagation(); speak(c.front); }} className="p-2 hover:bg-slate-100 rounded-lg">
                        <Icon name="volume-2" size={16} className="text-muted" />
                      </button>
                      <button onClick={(e) => { e.stopPropagation(); deleteCard(c.id); }} className="p-2 hover:bg-red-50 rounded-lg">
                        <Icon name="trash-2" size={16} className="text-coral" />
                      </button>
                    </div>
                  </div>
                ))
              )}
            </div>

            <button onClick={() => deleteDeck(selDeck.id)} className="w-full py-3 rounded-xl text-coral border border-red-200 hover:bg-red-50">
              Delete Deck
            </button>
          </div>
        )}

        {/* STUDY VIEW */}
        {view === 'study' && studyQ.length > 0 && (
          <div className="animate-fade-in flex flex-col" style={{ minHeight: 'calc(100vh - 200px)' }}>
            <div className="flex justify-between items-center mb-6">
              <button onClick={() => setView('home')} className="p-2 hover:bg-slate-100 rounded-xl">
                <Icon name="x" size={20} className="text-muted" />
              </button>
              <div className="flex items-center gap-3">
                <span className="text-sm text-muted font-medium">{currCard + 1}/{studyQ.length}</span>
                <div className="w-32 h-2 bg-slate-200 rounded-full overflow-hidden">
                  <div className="h-full bg-gradient-to-r from-primary to-gold rounded-full transition-all" 
                    style={{ width: `${((currCard + 1) / studyQ.length) * 100}%` }} />
                </div>
              </div>
            </div>

            <div className="flex-1 card-flip">
              <div onClick={() => !flipped && setFlipped(true)}
                className={`card-flip-inner w-full h-full ${flipped ? 'flipped' : ''}`} style={{ minHeight: '360px' }}>
                 
                <div className="card-front absolute inset-0 card p-8 flex flex-col items-center justify-center cursor-pointer shadow-elevated">
                  <h2 className="text-4xl font-bold mb-4 text-center">{studyQ[currCard].front}</h2>
                  {studyQ[currCard].phonetic && <p className="text-muted mb-6">{studyQ[currCard].phonetic}</p>}
                  <button onClick={(e) => { e.stopPropagation(); speak(studyQ[currCard].front); }}
                    className="p-4 bg-orange-50 rounded-full mb-8 hover:bg-orange-100">
                    <Icon name="volume-2" size={28} className="text-primary" />
                  </button>
                  <p className="text-muted text-sm animate-pulse">Tap to reveal</p>
                </div>

                <div className="card-back absolute inset-0 card p-6 flex flex-col items-center overflow-y-auto shadow-elevated">
                  <p className="text-muted text-sm mb-2">{studyQ[currCard].front}</p>
                  <h2 className="text-3xl font-bold gradient-text mb-4 text-center">{studyQ[currCard].back}</h2>
                   
                  {(aiData?.example || studyQ[currCard].example) && (
                    <div className="bg-slate-50 p-4 rounded-xl mb-4 w-full border border-slate-100">
                      <p className="text-sm text-body italic">"{aiData?.example || studyQ[currCard].example}"</p>
                    </div>
                  )}

                  {aiData && (
                    <div className="w-full space-y-3 mb-4">
                      {aiData.partOfSpeech && (
                        <span className="inline-block bg-violet-100 text-lavender px-3 py-1 rounded-full text-sm font-medium">
                          {aiData.partOfSpeech}
                        </span>
                      )}
                      {aiData.memoryTip && (
                        <div className="bg-amber-50 p-3 rounded-xl border border-amber-100">
                          <p className="text-xs text-gold font-medium mb-1">üí° Memory Tip</p>
                          <p className="text-sm text-body">{aiData.memoryTip}</p>
                        </div>
                      )}
                      {aiData.collocations && (
                        <div className="flex flex-wrap gap-2">
                          {aiData.collocations.map((col, i) => (
                            <span key={i} className="bg-emerald-50 text-mint px-2 py-1 rounded text-xs font-medium border border-emerald-100">{col}</span>
                          ))}
                        </div>
                      )}
                    </div>
                  )}

                  <div className="flex gap-2 w-full">
                    {!aiData && !studyQ[currCard].example && (
                      <button onClick={handleAI} disabled={aiLoading}
                        className="flex-1 bg-gradient-to-r from-amber-50 to-orange-50 text-primary px-4 py-2 rounded-full text-sm font-semibold border border-orange-100 flex items-center justify-center gap-2">
                        {aiLoading ? <Icon name="loader-2" size={16} className="animate-spin" /> : <Icon name="sparkles" size={16} />}
                        AI Explain
                      </button>
                    )}
                    <button onClick={() => setShowPractice(!showPractice)}
                      className={`flex-1 px-4 py-2 rounded-full text-sm font-semibold flex items-center justify-center gap-2 ${
                        showPractice ? 'bg-violet-500 text-white' : 'bg-violet-50 text-lavender border border-violet-200'
                      }`}>
                      <Icon name="pen-tool" size={16} /> Practice
                    </button>
                  </div>

                  {showPractice && <SentenceCheckPanel word={studyQ[currCard].front} apiKey={apiKey} onClose={() => setShowPractice(false)} />}
                </div>
              </div>
            </div>

            {flipped && (
              <div className="grid grid-cols-4 gap-2 mt-6">
                {[
                  { label: 'Again', color: 'bg-coral hover:bg-red-600' },
                  { label: 'Hard', color: 'bg-gold hover:bg-amber-600' },
                  { label: 'Good', color: 'bg-mint hover:bg-emerald-600' },
                  { label: 'Easy', color: 'bg-lavender hover:bg-violet-600' },
                ].map((btn, i) => (
                  <button key={i} onClick={() => handleReview(i)}
                    className={`${btn.color} text-white py-4 rounded-xl font-bold text-sm shadow-soft active:scale-95 transition-all`}>
                    {btn.label}
                  </button>
                ))}
              </div>
            )}
          </div>
        )}
      </main>

      {/* Bottom Nav */}
      {view !== 'study' && (
        <nav className="fixed bottom-0 w-full bg-white/90 backdrop-blur-lg z-30 pb-safe pt-2 px-6 border-t border-slate-100">
          <div className="flex justify-around items-center max-w-lg mx-auto">
            <button onClick={() => setView('home')} className={`p-3 rounded-xl ${view === 'home' ? 'bg-orange-50 text-primary' : 'text-muted'}`}>
              <Icon name="home" size={24} />
            </button>
            <button onClick={() => toggleModal('generateDeck', true)} className="p-4 btn-ai rounded-full -mt-6 shadow-lg">
              <Icon name="sparkles" size={26} />
            </button>
            <button onClick={() => setView('library')} className={`p-3 rounded-xl ${view === 'library' || view === 'deck' ? 'bg-orange-50 text-primary' : 'text-muted'}`}>
              <Icon name="library" size={24} />
            </button>
          </div>
        </nav>
      )}

      {/* MODALS */}
      {Object.values(modals).some(v => v) && (
        <div className="fixed inset-0 z-50 modal-backdrop flex items-end sm:items-center justify-center p-0 sm:p-4"
          onClick={() => setModals({ addDeck: false, addCard: false, import: false, settings: false, editCard: false, generateDeck: false })}>
          <div className="bg-white w-full sm:max-w-md rounded-t-3xl sm:rounded-3xl p-6 modal-content pb-safe animate-slide-up shadow-elevated"
            onClick={e => e.stopPropagation()}>
             
            {modals.addDeck && (
              <>
                <h3 className="text-xl font-bold mb-4">Create New Deck</h3>
                <input id="deckTitle" className="w-full input-clean p-4 rounded-xl mb-4" placeholder="e.g. Business Vocabulary" autoFocus />
                <button onClick={() => { const t = document.getElementById('deckTitle').value; if (t) createDeck(t); }}
                  className="w-full btn-primary py-4 rounded-xl">Create Deck</button>
              </>
            )}

            {modals.generateDeck && (
              <>
                <div className="flex items-center gap-3 mb-4">
                  <div className="p-2 bg-violet-100 rounded-xl"><Icon name="sparkles" size={24} className="text-lavender" /></div>
                  <div>
                    <h3 className="text-xl font-bold">Generate with AI</h3>
                    <p className="text-sm text-muted">Create vocabulary deck instantly</p>
                  </div>
                </div>
                <div className="space-y-4">
                  <div>
                    <label className="text-sm font-medium text-body block mb-2">Topic / ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</label>
                    <input value={genTopic} onChange={e => setGenTopic(e.target.value)}
                      className="w-full input-clean p-4 rounded-xl" placeholder="e.g. Business Meeting, Travel..." autoFocus />
                  </div>
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="text-sm font-medium text-body block mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥</label>
                      <select value={genCount} onChange={e => setGenCount(Number(e.target.value))} className="w-full input-clean p-3 rounded-xl">
                        <option value={5}>5 words</option>
                        <option value={10}>10 words</option>
                        <option value={15}>15 words</option>
                        <option value={20}>20 words</option>
                      </select>
                    </div>
                    <div>
                      <label className="text-sm font-medium text-body block mb-2">‡∏£‡∏∞‡∏î‡∏±‡∏ö</label>
                      <select value={genLevel} onChange={e => setGenLevel(e.target.value)} className="w-full input-clean p-3 rounded-xl">
                        <option value="Basic">Basic</option>
                        <option value="Intermediate">Intermediate</option>
                        <option value="Advanced">Advanced</option>
                      </select>
                    </div>
                  </div>
                </div>
                <button onClick={handleGenerateDeck} disabled={generating || !genTopic.trim()}
                  className="w-full btn-ai py-4 rounded-xl mt-4 flex items-center justify-center gap-2 disabled:opacity-50">
                  {generating ? <><Icon name="loader-2" size={20} className="animate-spin" /> Generating...</> : <><Icon name="sparkles" size={20} /> Generate Deck</>}
                </button>
              </>
            )}

            {modals.addCard && (
              <>
                <h3 className="text-xl font-bold mb-4">Add New Card</h3>
                <input id="cardFront" className="w-full input-clean p-4 rounded-xl mb-3" placeholder="Word (English)" autoFocus />
                <input id="cardBack" className="w-full input-clean p-4 rounded-xl mb-3" placeholder="Meaning (Thai)" />
                <input id="cardPhonetic" className="w-full input-clean p-4 rounded-xl mb-3" placeholder="Phonetic (optional)" />
                <input id="cardExample" className="w-full input-clean p-4 rounded-xl mb-4" placeholder="Example (optional)" />
                <button onClick={() => {
                  const front = document.getElementById('cardFront').value;
                  const back = document.getElementById('cardBack').value;
                  if (front && back) addCard({ front, back, phonetic: document.getElementById('cardPhonetic').value, example: document.getElementById('cardExample').value });
                }} className="w-full btn-primary py-4 rounded-xl">Add Card</button>
              </>
            )}

            {modals.editCard && editingCard && (
              <>
                <h3 className="text-xl font-bold mb-4">Edit Card</h3>
                <input id="editFront" className="w-full input-clean p-4 rounded-xl mb-3" defaultValue={editingCard.front} />
                <input id="editBack" className="w-full input-clean p-4 rounded-xl mb-3" defaultValue={editingCard.back} />
                <input id="editPhonetic" className="w-full input-clean p-4 rounded-xl mb-3" placeholder="Phonetic" defaultValue={editingCard.phonetic || ''} />
                <input id="editExample" className="w-full input-clean p-4 rounded-xl mb-4" placeholder="Example" defaultValue={editingCard.example || ''} />
                <button onClick={() => updateCard(editingCard.id, {
                  front: document.getElementById('editFront').value, back: document.getElementById('editBack').value,
                  phonetic: document.getElementById('editPhonetic').value, example: document.getElementById('editExample').value,
                })} className="w-full btn-primary py-4 rounded-xl">Save Changes</button>
              </>
            )}

            {modals.import && (
              <>
                <h3 className="text-xl font-bold mb-2">Import CSV</h3>
                <p className="text-sm text-muted mb-4">Format: word, meaning, phonetic, example</p>
                <textarea id="csvInput" className="w-full input-clean p-4 rounded-xl h-40 mb-4 font-mono text-sm"
                  placeholder="accomplish, ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à, /…ôÀàk…ëÀêmpl…™ É/, We accomplished our goals." />
                <button onClick={() => importCSV(document.getElementById('csvInput').value)}
                  className="w-full btn-primary py-4 rounded-xl">Import Cards</button>
              </>
            )}

            {modals.settings && (
              <>
                <h3 className="text-xl font-bold mb-6">Settings</h3>
                <div className="mb-6">
                  <label className="text-xs font-bold text-muted uppercase block mb-2">Gemini API Key</label>
                  <input value={apiKey} onChange={e => setApiKey(e.target.value)}
                    className="w-full input-clean p-3 rounded-xl mb-3" type="password" placeholder="Enter API key" />
                  <button onClick={() => { DB.setApiKey(apiKey); notify('API key saved'); }}
                    className="w-full border-2 border-lavender text-lavender py-3 rounded-xl font-semibold hover:bg-violet-50">Save API Key</button>
                  <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer"
                    className="text-xs text-sky hover:underline mt-2 inline-block">‚Üí Get free API key</a>
                </div>
                <div className="mb-6">
                  <label className="text-xs font-bold text-muted uppercase block mb-2">Sync Key</label>
                  <div className="flex gap-2">
                    <input id="syncKeyInput" className="flex-1 input-clean p-3 rounded-xl font-mono text-sm" placeholder="Enter sync key" defaultValue={currentSyncKey} />
                    <button onClick={() => { const v = document.getElementById('syncKeyInput').value; if (v) navigator.clipboard.writeText(v).then(() => notify('Copied!')); }}
                      className="p-3 btn-secondary rounded-xl"><Icon name="copy" size={18} /></button>
                  </div>
                  <button onClick={() => updateSyncKey(document.getElementById('syncKeyInput').value)}
                    className="w-full mt-3 border-2 border-primary text-primary py-3 rounded-xl font-semibold hover:bg-orange-50">Update Sync Key</button>
                </div>
                {/* ‚úÖ Smart Sync Status */}
                <div className="bg-emerald-50 rounded-xl p-4 border border-emerald-200">
                  <div className="flex items-center gap-2 mb-2">
                    <Icon name="shield-check" size={18} className="text-mint" />
                    <span className="text-sm font-semibold text-mint">Smart Sync v8.3</span>
                  </div>
                  <p className="text-xs text-body">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å merge ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏≤‡∏ç‡∏â‡∏•‡∏≤‡∏î ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á progress ‚úÖ</p>
                </div>
              </>
            )}
          </div>
        </div>
      )}

      <ConfirmDialog isOpen={confirmDialog.isOpen} title={confirmDialog.title} message={confirmDialog.message}
        type={confirmDialog.type} onConfirm={confirmDialog.onConfirm} onCancel={() => setConfirmDialog({ isOpen: false })} />

      {toast && (
        <div className={`fixed top-20 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full shadow-elevated z-[70] font-semibold text-sm flex items-center gap-2 animate-scale-in ${
          toast.type === 'error' ? 'bg-coral text-white' : toast.type === 'warning' ? 'bg-gold text-white' : 'bg-mint text-white'
        }`}>
          <Icon name={toast.type === 'error' ? 'alert-circle' : toast.type === 'warning' ? 'alert-triangle' : 'check'} size={16} />
          {toast.msg}
        </div>
      )}
    </div>
  );
}

ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
